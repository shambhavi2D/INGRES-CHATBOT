<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Jal Mitra - Groundwater Analytics AI</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<!-- React + ReactDOM + Babel (for quick prototyping) -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --bg: #0f172a;
  --card: #0b1220;
  --accent: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
  --muted: #94a3b8;
  --user: #0ea5a4;
  --bot: #111827;
  --text-primary: #e6eef8;
  --text-secondary: #dbeafe;
  --text-muted: #94a3b8;
  --border: rgba(255,255,255,0.08);
  --input-bg: rgba(255,255,255,0.03);
  --bubble-user-bg: linear-gradient(135deg, rgba(14,165,164,0.15), rgba(59,130,246,0.15));
  --bubble-bot-bg: rgba(255,255,255,0.04);
  --shadow: rgba(2,6,23,0.6);
  --gradient-bg: linear-gradient(180deg, #071025 0%, #071a2a 100%);
  --container-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
}

[data-theme="light"] {
  --bg: #ffffff;
  --card: #f8fafc;
  --accent: #3b82f6;
  --accent-gradient: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
  --muted: #64748b;
  --user: #0ea5a4;
  --bot: #f1f5f9;
  --text-primary: #1e293b;
  --text-secondary: #334155;
  --text-muted: #64748b;
  --border: rgba(0,0,0,0.12);
  --input-bg: rgba(0,0,0,0.04);
  --bubble-user-bg: linear-gradient(135deg, rgba(14,165,164,0.10), rgba(59,130,246,0.10));
  --bubble-bot-bg: #ffffff;
  --shadow: rgba(0,0,0,0.1);
  --gradient-bg: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
  --container-bg: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.01));
}

* { 
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  height: 100vh;
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: var(--gradient-bg);
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-primary);
  transition: background 0.3s ease, color 0.3s ease;
  overflow: hidden;
}

.container {
  width: 95vw;
  height: 85vh;
  background: var(--container-bg);
  border-radius: 16px;
  box-shadow: 0 20px 40px var(--shadow);
  display: grid;
  grid-template-columns: 280px 1fr;
  overflow: hidden;
}

/* Left pane - Slim sidebar */
.left {
  background: var(--input-bg); 
  padding: 20px; 
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 16px;
  overflow-y: auto;
  min-width: 280px;
}

.brand {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 700;
  font-size: 20px;
  margin-bottom: 10px;
  color: var(--accent);
}

.brand i {
  font-size: 28px;
}

.lang-select, .theme-toggle, .server-input {
  width: 100%; 
  background: var(--input-bg); 
  border: 1px solid var(--border); 
  color: var(--text-muted);
  padding: 10px 12px; 
  border-radius: 10px; 
  margin-bottom: 10px; 
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease;
}

.server-input { 
  cursor: text; 
}

.theme-toggle:hover, .lang-select:hover {
  background: var(--accent); 
  color: white; 
  border-color: var(--accent);
  transform: translateY(-2px);
}

.pill, .mock-btn {
  display: inline-flex; 
  align-items: center; 
  gap: 6px; 
  padding: 8px 12px; 
  border-radius: 10px;
  background: var(--input-bg); 
  color: var(--text-muted); 
  border: 1px dashed var(--border);
  cursor: pointer; 
  margin: 4px 6px 10px 0; 
  font-size: 12px; 
  transition: all 0.2s ease;
}

.pill:hover, .mock-btn:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
  transform: translateY(-2px);
}

/* Collapsible help */
.help { 
  border: 1px solid var(--border); 
  border-radius: 10px; 
  background: var(--bubble-bot-bg); 
  overflow: hidden; 
  margin-top: 8px; 
}

.help summary { 
  list-style: none; 
  cursor: pointer; 
  padding: 10px 12px; 
  user-select: none; 
  color: var(--text-secondary);
  font-weight: 500;
  font-size: 13px;
}

.help summary::-webkit-details-marker { 
  display: none; 
}

.help .content { 
  padding: 0 12px 12px 12px; 
  color: var(--text-muted); 
  font-size: 12px; 
  line-height: 1.4;
}

/* Right pane / chat - Main content area */
.right { 
  display: flex; 
  flex-direction: column; 
  height: 100%;
  padding: 0;
}

.messages { 
  flex: 1; 
  overflow-y: auto; 
  padding: 20px; 
  display: flex; 
  flex-direction: column; 
  gap: 16px; 
  scrollbar-width: thin;
}

.messages::-webkit-scrollbar {
  width: 6px;
}

.messages::-webkit-scrollbar-track {
  background: var(--input-bg);
  border-radius: 3px;
}

.messages::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

.bubble { 
  position: relative; 
  max-width: 80%; 
  padding: 14px 18px; 
  border-radius: 16px; 
  line-height: 1.5; 
  box-shadow: 0 4px 12px var(--shadow); 
  word-break: break-word;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.bubble.user { 
  align-self: flex-end; 
  background: var(--bubble-user-bg); 
  border: 1px solid rgba(14,165,164,0.18); 
}

.bubble.bot { 
  align-self: flex-start; 
  background: var(--bubble-bot-bg); 
  border: 1px solid var(--border); 
}

.meta { 
  font-size: 11px; 
  color: var(--text-muted); 
  margin-bottom: 6px; 
  user-select: none; 
  display: flex;
  align-items: center;
  gap: 6px;
}

.copy-btn { 
  position: absolute; 
  right: 10px; 
  bottom: 10px; 
  border: 1px solid var(--border); 
  background: var(--input-bg); 
  color: var(--text-muted); 
  border-radius: 6px; 
  font-size: 11px; 
  padding: 4px 8px; 
  cursor: pointer; 
  opacity: 0; 
  transition: all 0.2s ease; 
}

.copy-btn:hover {
  background: var(--accent);
  color: white;
}

.bubble:hover .copy-btn { 
  opacity: 1; 
}

/* Input */
.input-row { 
  display: flex; 
  gap: 10px; 
  padding: 16px 20px; 
  border-top: 1px solid var(--border); 
  background: var(--container-bg);
  align-items: flex-end;
  flex-shrink: 0;
}

.input {
  flex: 1; 
  padding: 12px 14px; 
  border-radius: 12px; 
  border: 1px solid var(--border); 
  outline: none; 
  background: var(--input-bg);
  color: var(--text-primary); 
  font-size: 14px; 
  resize: none; 
  min-height: 44px; 
  max-height: 100px;
  font-family: inherit;
  transition: border-color 0.2s ease;
}

.input:focus {
  border-color: var(--accent);
}

.btn { 
  padding: 12px 16px; 
  border-radius: 12px; 
  border: none; 
  background: var(--accent-gradient); 
  color: white; 
  cursor: pointer; 
  font-weight: 600;
  font-size: 14px;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 6px;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

.mic { 
  background: var(--input-bg); 
  border: 1px solid var(--border); 
  padding: 12px; 
  border-radius: 10px; 
  cursor: pointer; 
  color: var(--text-muted);
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mic:hover {
  background: var(--accent);
  color: white;
  border-color: var(--accent);
}

/* Table */
.resp-table { 
  border-collapse: collapse; 
  width: 100%; 
  margin-top: 10px; 
  color: var(--text-secondary);
  font-size: 13px;
}

.resp-table th, .resp-table td { 
  border: 1px solid var(--border); 
  padding: 8px 10px; 
  text-align: left; 
}

.resp-table th { 
  background: var(--input-bg); 
  color: var(--text-primary); 
  font-weight: 600;
}

.resp-table tr:hover {
  background: var(--input-bg);
}

/* Skeletons */
.skel { 
  position: relative; 
  overflow: hidden; 
  background: var(--input-bg); 
  border: 1px solid var(--border); 
  border-radius: 12px; 
}

.skel::after { 
  content: ""; 
  position: absolute; 
  inset: 0; 
  transform: translateX(-100%); 
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent); 
  animation: shimmer 1.2s infinite; 
}

@keyframes shimmer { 
 100% { 
    transform: translateX(100%); 
  } 
}

.skel-line { 
  height: 10px; 
  margin: 6px 0; 
  border-radius: 5px; 
  background: var(--input-bg);
}

.skel-line.w-60 { width: 60%; } 
.skel-line.w-80 { width: 80%; } 
.skel-line.w-40 { width: 40%; }

.skel-chart { 
  height: 200px; 
  border-radius: 10px; 
}

/* Scroll-to-bottom */
.scroll-bottom { 
  position: sticky; 
  bottom: 16px; 
  align-self: flex-end; 
  margin-right: 16px; 
  z-index: 10; 
}

.scroll-bottom .fab { 
  display: none; 
  border: none; 
  border-radius: 50%; 
  padding: 12px; 
  background: var(--accent-gradient); 
  color: white; 
  cursor: pointer; 
  box-shadow: 0 6px 20px var(--shadow);
  transition: all 0.2s ease;
  font-size: 16px;
}

.scroll-bottom .fab:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px var(--shadow);
}

.scroll-bottom.show .fab { 
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Status indicators */
.status-indicator {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  padding: 3px 6px;
  border-radius: 10px;
  background: var(--input-bg);
}

.status-online {
  color: var(--success);
}

.status-offline {
  color: var(--error);
}

.status-typing {
  color: var(--warning);
}

.typing-indicator {
  display: inline-flex;
  align-items: center;
  gap: 3px;
}

.typing-dot {
  width: 5px;
  height: 5px;
  background-color: var(--warning);
  border-radius: 50%;
  animation: typing-animation 1.4s infinite ease-in-out;
}

@keyframes typing-animation {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-3px); }
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

/* Landscape optimization */
@media (min-width: 1024px) {
  .container {
    width: 92vw;
    height: 82vh;
    grid-template-columns: 260px 1fr;
  }
  
  .left {
    padding: 16px;
    min-width: 260px;
  }
  
  .brand {
    font-size: 18px;
  }
  
  .messages {
    padding: 16px;
  }
  
  .bubble {
    max-width: 75%;
    padding: 12px 16px;
  }
}

/* Small screens */
@media (max-width: 900px){
  .container { 
    grid-template-columns: 1fr; 
    height: 100vh;
    border-radius: 0;
    width: 100vw;
  }
  
  .left { 
    display: none; 
  }
  
  .messages {
    padding: 16px;
  }
  
  .input-row {
    padding: 12px 16px;
  }
  
  .bubble {
    max-width: 90%;
    padding: 12px 14px;
  }
}

/* Extra small */
@media (max-width: 480px){
  .brand {
    font-size: 16px;
  }
  
  .input-row {
    gap: 8px;
  }
  
  .btn, .mic {
    padding: 10px;
  }
  
  .bubble {
    padding: 10px 12px;
  }
  
  .input {
    font-size: 13px;
    padding: 10px 12px;
  }
}
</style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useRef, useMemo } = React;

/* ====== CONFIG: point this to your backend (FastAPI, Node, etc.) ====== */
const BACKEND_URL = "http://127.0.0.1:8002/chat";

/* ==== Helper: Convert backend table (array of objects) to headers/rows ==== */
function tableFromRecords(records) {
  if (!records || !records.length) return { headers: [], rows: [] };
  const headers = Object.keys(records[0]);
  const rows = records.map(r => headers.map(h => String(r[h] ?? "")));
  return { headers, rows };
}

/************* Chart (with lazy mount when visible) *************/
function ChartBlock({ config, height=220, theme='dark' }) {
  const canvasRef = useRef(null);
  const chartRef = useRef(null);

  useEffect(() => {
    const ctx = canvasRef.current.getContext('2d');
    if (chartRef.current) chartRef.current.destroy();

    const isDark = theme === 'dark';
    const textColor = isDark ? '#dbeafe' : '#334155';
    const gridColor = isDark ? 'rgba(203, 213, 225, 0.1)' : 'rgba(0, 0, 0, 0.1)';

    const chartType = config.chartType || config.type || 'line';
    const labels = (config.labels) ? config.labels
                  : (config.data && config.data.labels) ? config.data.labels
                  : [];
    const datasetsIn = (config.datasets) ? config.datasets
                     : (config.data && config.data.datasets) ? config.data.datasets
                     : [];

    const datasets = datasetsIn.map((ds, index) => ({
      label: ds.label,
      data: ds.data,
      tension: ds.tension ?? 0.35,
      fill: ds.fill ?? false,
      borderWidth: ds.borderWidth ?? 2,
      borderColor: ds.borderColor ?? (index === 0 ? '#3b82f6' : '#0ea5a4'),
      backgroundColor: ds.backgroundColor ?? (index === 0 ? '#3b82f6' : '#0ea5a4'),
      pointRadius: ds.pointRadius ?? 3,
      pointHoverRadius: ds.pointRadius ?? 5,
    }));

    const options = {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: textColor, font: { size: 12 } } },
        title: { display: !!config.title, text: config.title, color: textColor, font: { size: 14 } }
      },
      scales: {
        x: { ticks: { color: textColor, font: { size: 11 } }, grid: { color: gridColor }},
        y: { ticks: { color: textColor, font: { size: 11 } }, grid: { color: gridColor }}
      },
      ...(config.options || {})
    };

    chartRef.current = new Chart(ctx, { type: chartType, data: { labels, datasets }, options });
    return () => chartRef.current?.destroy();
  }, [config, theme]);

  return <div style={{ height }}><canvas ref={canvasRef} aria-label={config.title || 'Chart'} role="img" /></div>;
}

/* Lazy wrapper: render ChartBlock only when visible */
function LazyChart({ config, theme }) {
  const holderRef = useRef(null);
  const [visible, setVisible] = useState(false);

  useEffect(() => {
    const el = holderRef.current;
    if (!el) return;
    const io = new IntersectionObserver(([entry]) => {
      if (entry.isIntersecting) {
        setVisible(true);
        io.disconnect();
      }
    }, { rootMargin: '100px' });
    io.observe(el);
    return () => io.disconnect();
  }, []);

  return (
    <div ref={holderRef}>
      {visible
        ? <ChartBlock config={config} height={200} theme={theme} />
        : <div className="skel skel-chart" aria-hidden="true"></div>}
    </div>
  );
}

/************* Copy + Bubbles *************/
function CopyButton({ text }) {
  const [ok, setOk] = useState(false);
  return (
    <button className="copy-btn" onClick={async () => {
      try { await navigator.clipboard.writeText(text); setOk(true); setTimeout(() => setOk(false), 1000); } catch(e) {}
    }} aria-label="Copy message">
      {ok ? <i className="fas fa-check"></i> : <i className="fas fa-copy"></i>}
    </button>
  );
}

function MessageBubble({ who, meta, plainText, children }) {
  return (
    <div className={`bubble ${who}`} role="listitem" aria-live={who === 'bot' ? 'polite' : undefined}>
      {meta && <div className="meta">{meta}</div>}
      <div>{children}</div>
      {plainText ? <CopyButton text={plainText} /> : null}
    </div>
  );
}

/************* Content renderer *************/
function MessageContent({ payload, theme }) {
  if (!payload) return null;

  if (payload.type === 'text') {
    return <div>{payload.text}</div>;
  }

  if (payload.type === 'table') {
    const { title, text, headers, rows } = payload;
    return (
      <div>
        {text && <div style={{ marginBottom: 6 }}>{text}</div>}
        <div style={{ overflowX: 'auto' }}>
          <table className="resp-table" role="table" aria-label={title || 'Data table'}>
            <thead><tr>{headers.map((h,i) => <th key={i} scope="col">{h}</th>)}</tr></thead>
            <tbody>
              {rows.map((r,ri) => (<tr key={ri}>{r.map((cell,ci) => <td key={ci}>{cell}</td>)}</tr>))}
            </tbody>
          </table>
        </div>
      </div>
    );
  }

  if (payload.type === 'chart') {
    const { text, chartSpec } = payload;
    return (
      <div>
        {text && <div style={{ marginBottom: 6 }}>{text}</div>}
        <LazyChart config={chartSpec} theme={theme} />
      </div>
    );
  }

  return <div>{JSON.stringify(payload)}</div>;
}

/************* App *************/
function App(){
  const [messages, setMessages] = useState([
    {
      id:1,
      who: 'bot',
      meta: `Jal Mitra • ${new Date().toLocaleTimeString()}`,
      payload: { type:'text',
        text: 'Hi! I\'m Jal Mitra, your groundwater analytics assistant. Ask me about groundwater levels, recharge trends, comparisons, or forecasting.'
      }
    }
  ]);

  const [serverUrl, setServerUrl] = useState(() => BACKEND_URL);
  const [input, setInput] = useState('');
  const [lang, setLang] = useState('en');
  const [loading, setLoading] = useState(false);
  const [theme, setTheme] = useState(() => localStorage.getItem('ingres-theme') || 'dark');
  const [showFab, setShowFab] = useState(false);
  const [connectionStatus, setConnectionStatus] = useState('checking');

  const msgRef = useRef(null);
  const inputRef = useRef(null);

  /* Scroll to bottom when new messages */
  useEffect(() => {
    if (!msgRef.current) return;
    msgRef.current.scrollTo({ top: msgRef.current.scrollHeight, behavior: "smooth" });
  }, [messages]);

  /* Track scroll to toggle FAB */
  useEffect(() => {
    const el = msgRef.current;
    if (!el) return;
    const onScroll = () => {
      const nearBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 80;
      setShowFab(!nearBottom);
    };
    el.addEventListener('scroll', onScroll);
    onScroll();
    return () => el.removeEventListener('scroll', onScroll);
  }, []);

  useEffect(() => { inputRef.current?.focus(); }, []);
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('ingres-theme', theme);
  }, [theme]);

  useEffect(() => { localStorage.setItem('ingres-server', serverUrl); }, [serverUrl]);

  // Check backend connection
  useEffect(() => {
    const checkConnection = async () => {
      try {
        const response = await fetch(`${serverUrl.replace('/chat', '/health')}`);
        if (response.ok) {
          setConnectionStatus('online');
        } else {
          setConnectionStatus('offline');
        }
      } catch (error) {
        setConnectionStatus('offline');
      }
    };
    
    checkConnection();
    const interval = setInterval(checkConnection, 30000);
    return () => clearInterval(interval);
  }, [serverUrl]);

  const examplePrompts = useMemo(() => ([
    "Groundwater in Mumbai 2022",
    "Recharge trend Jaipur",
    "Stage distribution Telangana 2022",
    "Compare top districts by extraction",
    "Forecast water availability for Hyderabad"
  ]), []);

  function pushMessage(msg){
    setMessages(prev => [...prev, {...msg, id: Date.now()+Math.random()}]);
  }

  /* ===== REAL BACKEND CALL ===== */
  async function callBackend(queryText) {
    const res = await fetch(serverUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: queryText, lang })
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(`Backend error ${res.status}: ${txt}`);
    }

    return res.json();
  }

  /* Transform backend response -> UI payloads */
  function toUIPayloads(api) {
    const out = [];
    if (api.narrative) {
      let text = api.narrative;
      if (api.forecast && api.forecast.next_year != null) {
        const { next_year, forecast_value } = api.forecast;
        text += `\n\nForecast → ${next_year}: ${forecast_value}`;
      }
      out.push({ type: 'text', text });
    }
    if (api.chart && api.chart.type && api.chart.data) {
      const chartSpec = {
        type: api.chart.type,
        data: api.chart.data,
        options: api.chart.options || {},
        title: api.chart.data?.datasets?.[0]?.label || api.metric || 'Chart'
      };
      out.push({ type: 'chart', chartSpec, text: null });
    }
    if (Array.isArray(api.table) && api.table.length) {
      const { headers, rows } = tableFromRecords(api.table);
      out.push({
        type: 'table',
        title: `${api.metric || 'Summary'} ${api.filters?.year ? `(${api.filters.year})` : ''}`.trim(),
        headers, rows,
        text: null
      });
    }
    if (!out.length) {
      out.push({ type: 'text', text: 'No data returned for this query.' });
    }
    return out;
  }

  async function handleSend(){
    const trimmed = input.trim();
    if (!trimmed || loading) return;
    pushMessage({ who:'user', meta: `You • ${new Date().toLocaleTimeString()}`, payload: { type:'text', text: trimmed }, plainText: trimmed });
    setInput('');
    setLoading(true);

    try {
      const api = await callBackend(trimmed);
      const bubbles = toUIPayloads(api);
      bubbles.forEach(b => {
        const plain =
          b.type === 'text' ? b.text :
          b.type === 'table' ? (b.rows || []).map(r => r.join(' | ')).join('\n') :
          b.type === 'chart' ? (api.chart?.data?.labels || []).join(', ') :
          JSON.stringify(b);
        pushMessage({ who:'bot', meta: `Jal Mitra • ${new Date().toLocaleTimeString()}`, payload: b, plainText: plain });
      });
    } catch (err) {
      console.error(err);
      pushMessage({
        who:'bot',
        meta: `Jal Mitra • ${new Date().toLocaleTimeString()}`,
        payload: { type:'text', text: `Error: could not reach backend. ${err.message || ''}` },
        plainText: `Error: could not reach backend. ${err.message || ''}`
      });
    } finally {
      setLoading(false);
      inputRef.current?.focus();
    }
  }

  function handleKey(e){
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSend();
    }
  }

  function handleLanguageChange(e){
    setLang(e.target.value);
  }

  function toggleTheme(){ setTheme(prev => prev === 'dark' ? 'light' : 'dark'); }

  return (
    <div className="container" role="application" aria-label="Jal Mitra - Groundwater Analytics AI">
      <div className="left">
        <div className="brand">
          <i className="fas fa-droplet"></i>
          Jal Mitra
        </div>

        <div className="status-indicator">
          <i className={`fas fa-circle ${connectionStatus === 'online' ? 'status-online' : 'status-offline'}`}></i>
          {connectionStatus === 'online' ? 'Connected' : 'Offline'}
        </div>

        <button className="theme-toggle" onClick={toggleTheme} aria-label="Toggle theme">
          <i className={theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon'}></i>
          {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
        </button>

        <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 4 }}>Backend URL</div>
        <input className="server-input" value={serverUrl} onChange={e => setServerUrl(e.target.value)} placeholder="http://localhost:8002/chat" />

        <div style={{ fontSize: 12, color: 'var(--text-muted)', marginBottom: 6 }}>Language</div>
        <select className="lang-select" value={lang} onChange={handleLanguageChange} aria-label="Select language">
          <option value="en">English</option>
          <option value="hi">Hindi</option>
          <option value="mr">Marathi</option>
          <option value="bn">Bengali</option>
          <option value="ta">Tamil</option>
        </select>

        <div style={{ marginTop: 6, marginBottom: 4, fontSize: 12, color: 'var(--text-muted)' }}>Example prompts</div>
        <div>
          {examplePrompts.map((p,i) => (
            <span key={i} className="pill" role="button" tabIndex={0}
              onClick={() => { setInput(p); inputRef.current?.focus(); }}
              onKeyDown={e => { if(e.key==='Enter' || e.key===' ') { setInput(p); inputRef.current?.focus(); }}}>
              <i className="fas fa-lightbulb"></i> {p}
            </span>
          ))}
        </div>

        <details className="help">
          <summary><i className="fas fa-question-circle"></i> How to use</summary>
          <div className="content">
            <ul style={{ margin: '6px 0 0 14px' }}>
              <li>Start backend: <code>python -m uvicorn main:app --reload</code></li>
              <li>Ask about groundwater data, trends, forecasts</li>
              <li>Copy messages with the Copy button</li>
              <li>Charts load when visible</li>
            </ul>
          </div>
        </details>
      </div>

      <div className="right">
        <div ref={msgRef} className="messages" id="messages" role="list" aria-live="polite" aria-relevant="additions">
          {messages.map(m => (
            <MessageBubble key={m.id} who={m.who} meta={m.meta} plainText={m.plainText}>
              <MessageContent payload={m.payload} theme={theme} />
            </MessageBubble>
          ))}

          {loading && (
            <div className="bubble bot" aria-label="Bot is typing" role="status" aria-live="polite">
              <div className="meta">
                <i className="fas fa-robot"></i> Jal Mitra • 
                <span className="status-typing">typing</span>
                <span className="typing-indicator">
                  <span className="typing-dot"></span>
                  <span className="typing-dot"></span>
                  <span className="typing-dot"></span>
                </span>
              </div>
              <div className="skel skel-line w-80"></div>
              <div className="skel skel-line w-60"></div>
              <div className="skel skel-line w-40"></div>
              <div style={{ marginTop: 8 }} className="skel skel-chart"></div>
            </div>
          )}

          <div className={`scroll-bottom ${showFab ? 'show' : ''}`}>
            <button className="fab" onClick={() => {
              msgRef.current?.scrollTo({top: msgRef.current.scrollHeight, behavior: 'smooth'});
            }} aria-label="Scroll to latest">
              <i className="fas fa-arrow-down"></i>
            </button>
          </div>
        </div>

        {!input.trim() && !loading && messages.length <= 2 && (
          <div style={{ padding: '0 16px 8px 16px' }}>
            {examplePrompts.map((p,i) => (
              <span key={'bottom-'+i} className="pill" role="button" tabIndex={0}
                onClick={() => { setInput(p); inputRef.current?.focus(); }}
                onKeyDown={e => { if(e.key==='Enter' || e.key===' ') { setInput(p); inputRef.current?.focus(); }}}>
                <i className="fas fa-lightbulb"></i> {p}
              </span>
            ))}
          </div>
        )}

        <div className="input-row">
          <button className="mic" title="Voice (placeholder)" disabled={loading} aria-label="Voice input (not implemented)">
            <i className="fas fa-microphone"></i>
          </button>
          <textarea
            className="input"
            value={input}
            onChange={e => setInput(e.target.value)}
            onKeyDown={handleKey}
            placeholder="Ask about groundwater data (e.g., 'groundwater in Mumbai 2022')"
            disabled={loading}
            ref={inputRef}
            aria-label="Chat input"
            rows={2}
          />
          <button className="btn" onClick={handleSend} disabled={loading || !input.trim()} aria-label="Send message">
            {loading ? <i className="fas fa-spinner fa-spin"></i> : <i className="fas fa-paper-plane"></i>}
            {loading ? "Sending..." : "Send"}
          </button>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>